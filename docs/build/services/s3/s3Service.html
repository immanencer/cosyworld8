
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S3 Service - CosyWorld Documentation</title>
  <!-- Mermaid script for diagram rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      mermaid.initialize({ 
        startOnLoad: true,
        theme: 'dark',
        securityLevel: 'loose'
      });
    });
  </script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
    }
    nav {
      width: 250px;
      padding-right: 2rem;
      flex-shrink: 0;
    }
    main {
      flex-grow: 1;
    }
    code {
      background: #f5f5f5;
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
      font-size: 85%;
    }
    pre {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 5px;
      overflow: auto;
    }
    pre code {
      background: none;
      padding: 0;
    }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    h1, h2, h3, h4 { margin-top: 1.5em; margin-bottom: 0.5em; }
    h1 { border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    nav ul { list-style-type: none; padding-left: 1.2em; }
    nav > ul { padding-left: 0; }
    .section-title { 
      font-weight: bold; 
      margin-top: 1em;
      color: #24292e;
    }
    /* Mermaid diagram styling */
    .mermaid {
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <nav><ul><li><a href="../../index.html">Home</a></li><li><span class="section-title">Overview</span><ul><li><a href="../../overview/03-system-diagram.html">System Diagram</a></li><li><a href="../../overview/02-system-overview.html">System Overview</a></li><li><a href="../../overview/01-introduction.html">CosyWorld Introduction</a></li></ul></li><li><span class="section-title">Systems</span><ul><li><a href="../../systems/06-dungeon-system.html">Dungeon System</a></li><li><a href="../../systems/05-intelligence-system.html">Intelligence System</a></li><li><a href="../../systems/04-action-system.html">Action System</a></li></ul></li><li><span class="section-title">Services</span><ul><li><a href="../../services/architecture-report.html">CosyWorld Architecture Report</a></li><li><a href="../../services/README.html">CosyWorld Services Documentation</a></li><li><span class="section-title">Web</span><ul><li><a href="../../services/web/webService.html">Web Service</a></li></ul></li><li><span class="section-title">Tools</span><ul><li><a href="../../services/tools/toolService.html">Tool Service</a></li></ul></li><li><span class="section-title">S3</span><ul><li><a href="../../services/s3/s3Service.html">S3 Service</a></li></ul></li><li><span class="section-title">Quest</span><ul><li><a href="../../services/quest/questGeneratorService.html">Quest Generator Service</a></li></ul></li><li><span class="section-title">Location</span><ul><li><a href="../../services/location/locationService.html">Location Service</a></li></ul></li><li><span class="section-title">Item</span><ul><li><a href="../../services/item/itemService.html">Item Service</a></li></ul></li><li><span class="section-title">Core</span><ul><li><a href="../../services/core/promptService.html">Prompt Service</a></li><li><a href="../../services/core/memoryService.html">Memory Service</a></li><li><a href="../../services/core/databaseService.html">Database Service</a></li><li><a href="../../services/core/basicService.html">Basic Service</a></li><li><a href="../../services/core/avatarService.html">Avatar Service</a></li><li><a href="../../services/core/aiService.html">AI Service</a></li></ul></li><li><span class="section-title">Chat</span><ul><li><a href="../../services/chat/conversationManager.html">Conversation Manager</a></li></ul></li></ul></li><li><span class="section-title">Deployment</span><ul><li><a href="../../deployment/08-future-work.html">Future Work Priorities</a></li><li><a href="../../deployment/07-deployment.html">Deployment Guide</a></li></ul></li></ul></nav>
  <main><h1>S3 Service</h1>
<h2>Overview</h2>
<p>The S3Service provides an interface for storing and retrieving files using Amazon S3 or compatible storage services. It handles upload, download, and management of various media assets and data files used throughout the system.</p>
<h2>Functionality</h2>
<ul>
<li><strong>File Upload</strong>: Stores files in S3-compatible storage</li>
<li><strong>File Retrieval</strong>: Fetches files by key</li>
<li><strong>URL Generation</strong>: Creates temporary or permanent access URLs</li>
<li><strong>Bucket Management</strong>: Handles bucket creation and configuration</li>
<li><strong>Metadata Management</strong>: Sets and retrieves file metadata</li>
</ul>
<h2>Implementation</h2>
<p>The S3Service extends BasicService and uses the AWS SDK to interact with S3-compatible storage services. It supports both direct file operations and signed URL generation for client-side uploads.</p>
<pre><code class="language-javascript">export class S3Service extends BasicService {
  constructor(services) {
    super(services, [
      'configService',
      'logger',
    ]);
    
    this.initialize();
  }
  
  initialize() {
    const awsConfig = this.configService.get('aws') || {};
    this.s3Client = new S3Client({
      region: process.env.AWS_REGION || awsConfig.region || 'us-east-1',
      credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID || awsConfig.accessKeyId,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || awsConfig.secretAccessKey,
      }
    });
    
    this.bucketName = process.env.S3_BUCKET_NAME || awsConfig.bucketName;
    this.initialized = true;
  }
  
  // Methods...
}
</code></pre>
<h3>Key Methods</h3>
<h4><code>uploadFile(fileBuffer, key, contentType, metadata = {})</code></h4>
<p>Uploads a file buffer to S3 storage with the specified key and content type.</p>
<h4><code>uploadBase64Image(base64Data, key, metadata = {})</code></h4>
<p>Converts and uploads a base64-encoded image to S3.</p>
<h4><code>getSignedUrl(key, operation, expiresIn = 3600)</code></h4>
<p>Generates a signed URL for client-side operations (get or put).</p>
<h4><code>downloadFile(key)</code></h4>
<p>Downloads a file from S3 storage by its key.</p>
<h4><code>deleteFile(key)</code></h4>
<p>Removes a file from S3 storage.</p>
<h4><code>listFiles(prefix)</code></h4>
<p>Lists files in the bucket with the specified prefix.</p>
<h2>File Organization</h2>
<p>The service uses a structured key format to organize files:</p>
<ul>
<li><code>avatars/[avatarId]/[filename]</code> for avatar images</li>
<li><code>locations/[locationId]/[filename]</code> for location images</li>
<li><code>items/[itemId]/[filename]</code> for item images</li>
<li><code>temp/[sessionId]/[filename]</code> for temporary uploads</li>
<li><code>backups/[date]/[filename]</code> for system backups</li>
</ul>
<h2>Security Features</h2>
<ul>
<li>Automatic encryption for sensitive files</li>
<li>Signed URLs with expiration for controlled access</li>
<li>Bucket policy enforcement for access control</li>
<li>CORS configuration for web integration</li>
</ul>
<h2>Dependencies</h2>
<ul>
<li>AWS SDK for JavaScript</li>
<li>ConfigService for AWS credentials and settings</li>
<li>Logger for operation tracking</li>
</ul>
</main>
</body>
</html>
