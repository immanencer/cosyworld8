document.addEventListener("DOMContentLoaded",(()=>{const e={metadataViewer:document.getElementById("metadata-viewer"),cardContainer:document.getElementById("card-pack-container")||document.getElementById("packs-container"),openRandomBtn:document.getElementById("open-random-pack"),pagination:document.getElementById("pagination-container"),notification:document.getElementById("notification")||function(){const e=document.createElement("div");return e.id="notification",e.className="notification",document.body.appendChild(e),e}(),encryptionKey:document.getElementById("encryption-key"),redeemBtn:document.getElementById("redeem-pack"),keyContainer:document.getElementById("user-key-container"),userKey:document.getElementById("user-key-display"),requestKeyBtn:document.getElementById("request-key-btn")};let t=[],n=null;function a(t,n="info"){const{notification:a}=e;a.textContent=t,a.className="notification show",a.style.backgroundColor="success"===n?"#10B981":"error"===n?"#EF4444":"warning"===n?"#F59E0B":"#6366F1",setTimeout((()=>{a.className="notification"}),3e3)}function o(){let e=localStorage.getItem("rati_user_id");return e||(e="user_"+Date.now()+"_"+Math.random().toString(36).substring(2,15),localStorage.setItem("rati_user_id",e)),e}function r(){const e=o(),t=localStorage.getItem(`rati_user_key_${e}`);if(t)try{return n=JSON.parse(t),i(n.key),n}catch(e){console.error("Failed to parse stored user key:",e)}return null}function i(t){e.userKey&&(e.userKey.textContent=t,e.keyContainer&&e.keyContainer.classList.remove("hidden"))}async function s(){try{const e=await fetch("/api/rati/user/key",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:o()})});if(!e.ok){const t=await e.json();throw new Error(t.message||"Failed to request user key")}const t=await e.json();return n={key:t.key,issuedAt:(new Date).toISOString()},localStorage.setItem(`rati_user_key_${o()}`,JSON.stringify(n)),i(n.key),a("User key obtained successfully!","success"),l(),n}catch(e){return console.error("Error requesting user key:",e),a(e.message||"Failed to request user key","error"),null}}function c(e){const t=o(),n=d(),a=n.findIndex((t=>t.packId===e.packId));-1!==a?n[a]=e:n.push(e),localStorage.setItem(`rati_packs_${t}`,JSON.stringify(n))}function d(){const e=o(),t=localStorage.getItem(`rati_packs_${e}`);return t?JSON.parse(t):[]}async function l(e=1,o=9){try{if(!n&&!r())return void u("You need a user key to view packs",!0);const a=await fetch(`/api/rati/packs/all?page=${e}&limit=${o}&userKey=${n.key}`);if(!a.ok)throw new Error("Failed to fetch packs");const i=(await a.json()).packs||[],s=d();let c=[...i];s.forEach((e=>{e.opened&&(c=c.filter((t=>t.packId!==e.packId)),c.push(e))})),t=c,p(t)}catch(e){console.error("Error fetching packs:",e),a("Failed to load packs. Please try again.","error");const n=d();n.length>0?(t=n,p(n),a("Showing your saved packs.","info")):u()}}function u(t="No packs found",n=!1){const{cardContainer:a}=e;a.innerHTML=`\n      <div class="text-center py-12 glassmorphism rounded-xl">\n        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>\n        </svg>\n        <h3 class="mt-2 text-sm font-medium text-gray-900">${t}</h3>\n        <p class="mt-1 text-sm text-gray-500">Get started by redeeming a pack with your encryption key.</p>\n        ${n?'\n          <button id="empty-state-request-key" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">\n            Request User Key\n          </button>\n        ':""}\n      </div>\n    `;const o=document.getElementById("empty-state-request-key");o&&o.addEventListener("click",s)}function p(n){const{cardContainer:o}=e;if(!Array.isArray(n))return console.error("Invalid packs data:",n),void u();if(0===n.length)return void u();let r="";r+='<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">',n.forEach((e=>{const t=!0===e.opened;r+=`\n        <div class="pack-card relative" data-id="${e.packId||"unknown"}">\n          <div class="card ${t?"flipped":""}">\n            <div class="card-face card-back flex flex-col items-center justify-center">\n              <div class="text-white text-center">\n                <h3 class="font-bold text-lg mb-1">Mystery Pack</h3>\n                <p class="text-sm opacity-70">Click to reveal</p>\n              </div>\n            </div>\n            <div class="card-face card-front">\n              <div class="card-image-container">\n                <img class="card-image" src="${e.imageUrl||"https://via.placeholder.com/300x180?text=Card+Pack"}" alt="Card Pack">\n              </div>\n              <div class="card-content">\n                <h3 class="font-semibold text-indigo-800">Pack #${e.packId||"Unknown"}</h3>\n                ${t?'<p class="text-xs text-indigo-600">Opened</p>':'<p class="text-xs text-gray-500">Click to open</p>'}\n              </div>\n            </div>\n          </div>\n          ${t?'<div class="absolute top-2 right-2 bg-indigo-600 text-white text-xs px-2 py-1 rounded-full">Opened</div>':""}\n        </div>\n      `})),r+="</div>",o.innerHTML=r,document.querySelectorAll(".card").forEach((e=>{e.addEventListener("click",(()=>function(e){const n=e.parentElement.dataset.id,o=t.find((e=>e.packId==n));o?o.opened?(m(o),e.classList.contains("flipped")||e.classList.add("flipped")):y(n,e):a("Pack not found","error")}(e)))}))}async function y(e,o){try{if(!n)return void a("You need a user key to open packs","error");const r=await fetch(`/api/rati/packs/${e}/open`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userKey:n.key})});if(!r.ok){const e=await r.json();throw new Error(e.message||"Failed to open pack")}const i=await r.json(),s=t.findIndex((t=>t.packId==e));-1!==s&&(t[s]={...t[s],...i.pack,opened:!0},c(t[s]),o&&o.classList.add("flipped"),m(t[s]),a("Pack opened successfully!","success"))}catch(e){console.error("Error opening pack:",e),a(e.message||"Failed to open pack","error")}}function m(t){const{metadataViewer:n}=e;let a=JSON.stringify(t,null,2);n.textContent=a}r(),n?l():u("You need a user key to view packs",!0),e.openRandomBtn&&e.openRandomBtn.addEventListener("click",(function(){const e=t.filter((e=>!e.opened));if(0===e.length)return void a("No unopened packs available","warning");const n=e[Math.floor(Math.random()*e.length)],o=document.querySelector(`.pack-card[data-id="${n.packId}"] .card`);o?(o.scrollIntoView({behavior:"smooth",block:"center"}),o.classList.add("ring-4","ring-indigo-500","ring-opacity-50"),setTimeout((()=>{o.classList.remove("ring-4","ring-indigo-500","ring-opacity-50"),y(n.packId,o)}),800)):y(n.packId)})),e.redeemBtn&&e.redeemBtn.addEventListener("click",(async function(){const{encryptionKey:o}=e,r=o.value.trim();if(r){if(!n&&!await s())return void a("Failed to get user key. Cannot redeem pack.","error");try{const e=await fetch("/api/rati/packs/redeem",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({encryptionKey:r,userKey:n.key})});if(!e.ok){const t=await e.json();throw new Error(t.message||"Failed to redeem pack")}const i=await e.json();o.value="",i.packs&&Array.isArray(i.packs)&&(t=[...t,...i.packs],p(t)),a("Pack redeemed successfully!","success")}catch(e){console.error("Error redeeming pack:",e),a(e.message||"Failed to redeem pack","error")}}else a("Please enter an encryption key","warning")})),e.requestKeyBtn&&e.requestKeyBtn.addEventListener("click",s),setInterval((()=>{t.filter((e=>e.opened)).forEach((e=>c(e)))}),6e4)}));