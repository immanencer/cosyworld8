import{state}from"../core/state.js";import{AvatarAPI,ClaimsAPI}from"../core/api.js";import{showToast}from"../utils/toast.js";import{shortenAddress}from"../utils/formatting.js";export async function loadContent(){const t=document.getElementById("content");if(t)if(state.wallet&&state.wallet.publicKey)try{const n=await AvatarAPI.getAvatars({walletAddress:state.wallet.publicKey,view:"claims",page:1,limit:12});if(!n.avatars||0===n.avatars.length)return void renderEmptyState(t);renderAvatarGrid(t,await Promise.all(n.avatars.map((async t=>{try{const n=await ClaimsAPI.getStatus(t._id);return{...t,mintStatus:n.claimed&&!n.minted?"unminted":"minted",isClaimed:n.claimed,claimedBy:n.claimedBy||""}}catch(n){return console.warn(`Failed to get claim status for avatar ${t._id}:`,n),{...t,mintStatus:"unknown",isClaimed:!1,claimedBy:""}}})))),await loadUserClaims()}catch(n){console.error("Load Squad error:",n),t.innerHTML=`\n      <div class="text-center py-12 text-red-500">\n        Failed to load Squad: ${n.message}\n        <button class="mt-4 px-4 py-2 bg-primary-600 rounded" onclick="loadContent()">\n          Retry\n        </button>\n      </div>\n    `}else renderWalletPrompt(t)}function renderWalletPrompt(t){t.innerHTML='\n    <div class="text-center py-12">\n      <p class="mb-4">Connect your wallet to view your Squad</p>\n      <button class="px-4 py-2 bg-primary-600 hover:bg-primary-700 rounded text-white transition" onclick="connectWallet()">\n        Connect Wallet\n      </button>\n    </div>\n  '}function renderEmptyState(t){t.innerHTML='\n    <div class="max-w-4xl mx-auto px-4">\n      <div class="text-center py-12">\n        <h2 class="text-2xl font-bold mb-4">No Squad Members Found</h2>\n        <p class="text-gray-400 mb-6">\n          You haven\'t claimed any avatars yet. Explore the leaderboard to find avatars to claim!\n        </p>\n        <button \n          onclick="setActiveTab(\'leaderboard\')" \n          class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded transition"\n        >\n          Browse Leaderboard\n        </button>\n      </div>\n    </div>\n  '}function renderAvatarGrid(t,n){const e=window.AvatarDetails?.renderAvatarCard||defaultRenderAvatarCard;t.innerHTML=`\n    <div class="max-w-7xl mx-auto px-4">\n      <div class="text-center py-4">\n        <h2 class="text-xl font-bold">Wallet: ${shortenAddress(state.wallet.publicKey)}</h2>\n      </div>\n      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">\n        ${n.map((t=>`\n          <div onclick="showAvatarDetails('${t._id}')" class="cursor-pointer relative">\n            ${e(t,null,t.isClaimed,t.claimedBy)}\n            ${"unminted"===t.mintStatus?'<div class="absolute top-2 right-2 px-2 py-1 bg-yellow-600 text-white text-xs rounded-full">\n              Unminted\n            </div>':""}\n          </div>\n        `)).join("")}\n      </div>\n      <div id="claims-container" class="mt-8"></div>\n      <div id="claim-form-container" class="mt-8 hidden"></div>\n    </div>\n  `}function defaultRenderAvatarCard(t,n,e,a){return`\n    <div class="bg-gray-800 rounded-lg overflow-hidden hover:bg-gray-750 transition-colors ${e?"border-l-2 border-green-500":""}">\n      <div class="aspect-w-1 aspect-h-1 relative">\n        <img \n          src="${t.thumbnailUrl||t.imageUrl}" \n          alt="${t.name}" \n          class="object-cover w-full h-full"\n          onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'100\\' viewBox=\\'0 0 100 100\\'%3E%3Crect fill=\\'%23333\\' width=\\'100\\' height=\\'100\\'/%3E%3Ctext fill=\\'%23FFF\\' x=\\'50\\' y=\\'50\\' font-size=\\'50\\' text-anchor=\\'middle\\' dominant-baseline=\\'middle\\'%3E${t.name.charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E';"\n        >\n      </div>\n      <div class="p-4">\n        <h3 class="font-bold text-lg truncate">${t.name}</h3>\n        <p class="text-sm text-gray-400 mt-1 truncate">${t.description||""}</p>\n      </div>\n    </div>\n  `}async function loadUserClaims(){const t=document.getElementById("claims-container");if(t&&state.wallet)try{const n=await fetch(`/api/claims?walletAddress=${state.wallet.publicKey}`),e=await n.json();if(!e.claims||0===e.claims.length)return void(t.innerHTML="");t.innerHTML=`\n      <div class="mt-8 bg-gray-800 rounded-lg p-6">\n        <h3 class="text-xl font-bold mb-4">Your Claims</h3>\n        <div class="space-y-4">\n          ${e.claims.map((t=>`\n            <div class="bg-gray-700 p-4 rounded-lg">\n              <div class="flex justify-between items-center">\n                <div>\n                  <p class="font-medium">${t.avatarName||"Avatar"}</p>\n                  <p class="text-sm text-gray-400">${new Date(t.claimedAt).toLocaleString()}</p>\n                </div>\n                <div>\n                  ${t.minted?'<span class="px-2 py-1 bg-green-600 text-white text-sm rounded-full">Minted</span>':`<button \n                      onclick="mintClaim('${t._id}')"\n                      class="px-3 py-1 bg-primary-600 hover:bg-primary-700 text-white text-sm rounded transition"\n                    >\n                      Mint Now\n                    </button>`}\n                </div>\n              </div>\n            </div>\n          `)).join("")}\n        </div>\n      </div>\n    `,window.mintClaim=mintClaim}catch(n){console.error("Load claims error:",n),t.innerHTML=`\n      <div class="mt-8 bg-gray-800 rounded-lg p-6">\n        <p class="text-red-500">Failed to load claims: ${n.message}</p>\n      </div>\n    `}}async function mintClaim(t){try{showToast("Minting started...");const n=await fetch(`/api/claims/mint/${t}`,{method:"POST",headers:{"Content-Type":"application/json"}}),e=await n.json();if(!e.success)throw new Error(e.error||"Minting failed");showToast("Minting successful!",{type:"success"}),loadContent()}catch(t){console.error("Mint error:",t),showToast(`Minting failed: ${t.message}`,{type:"error"})}}