(()=>{"use strict";function e(e,t){const s=document.getElementById("settings-message");s&&(s.textContent=e,s.classList.remove("hidden","text-green-500","text-red-500"),s.classList.add(`text-${"success"===t?"green":"red"}-500`),s.classList.remove("hidden"),setTimeout((()=>{s.classList.add("hidden")}),5e3))}async function t(){try{const e=await fetch("/api/audit-logs?type=guild_access&limit=50");if(!e.ok)return void console.error("Failed to fetch audit logs");const t=await e.json();console.log("Retrieved audit logs:",t);const n=await fetch("/api/guilds");if(!n.ok)return void console.error("Failed to fetch guild configs");const i=await n.json(),d=new Set(i.map((e=>e.guildId))),o=document.getElementById("detected-guilds-container");if(!o)return void console.error("Detected guilds container not found");const r=new Map;if(t.forEach((e=>{if("string"==typeof e.message){const s=e.message.match(/Guild\s+([^(]+)\s+\((\d+)\)\s+is\s+not\s+whitelisted/i),n=e.message.match(/Retrieved guild config for (\d+) from database: whitelisted=false/i);if(s&&s[1]&&s[2]){const e=s[1].trim(),t=s[2];d.has(t)||r.has(t)||r.set(t,{name:e,id:t})}else if(n&&n[1]){const e=n[1];if(!d.has(e)&&!r.has(e)){const s=t.find((t=>t.message&&t.message.includes(e)&&t.message.match(/Guild\s+([^(]+)\s+\((\d+)\)/i))),n=s?s.message.match(/Guild\s+([^(]+)\s+\((\d+)\)/i)[1].trim():`Server ${e}`;r.set(e,{name:n,id:e})}}}})),r.size>0){const e=document.getElementById("detected-guilds-section");e&&e.classList.remove("hidden"),o.innerHTML="";for(const e of r.values()){const t=document.createElement("div");t.classList.add("bg-white","border","border-yellow-300","shadow","rounded-lg","p-4","mb-3"),t.innerHTML=`\n          <div class="flex justify-between items-center">\n            <div>\n              <h3 class="text-lg font-semibold">${e.name}</h3>\n              <p class="text-sm text-gray-500">ID: ${e.id}</p>\n            </div>\n            <button\n              class="whitelist-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"\n              data-guild-id="${e.id}"\n              data-guild-name="${e.name}"\n            >\n              Whitelist\n            </button>\n          </div>\n        `;const n=t.querySelector(".whitelist-btn");n&&n.addEventListener("click",(e=>{e.preventDefault(),s(n.getAttribute("data-guild-id"),n.getAttribute("data-guild-name"))})),o.appendChild(t)}}else{const e=document.getElementById("detected-guilds-section");e&&e.classList.add("hidden")}}catch(e){console.error("Error checking for detected servers:",e)}}async function s(t,s){try{const n={guildId:t,guildName:s,whitelisted:!0,features:{breeding:!1,combat:!1,itemCreation:!1},prompts:{introduction:"",summon:"",attack:"",defend:"",breed:""},rateLimit:{messages:5,interval:6e4},summonEmoji:"âœ¨",toolEmojis:{summon:"ðŸ”®",breed:"ðŸ¹",attack:"âš”ï¸",defend:"ðŸ›¡ï¸"}},i=await fetch("/api/guilds",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!i.ok)throw new Error(`Failed to save guild configuration: ${i.status}`);e(`Server "${s}" has been whitelisted successfully!`,"success"),window.guildSettingsManager?(await window.guildSettingsManager.loadGuildConfigs(),window.guildSettingsManager.initializeGuildSelector()):window.location.reload()}catch(t){console.error("Error whitelisting detected guild:",t),e(`Failed to whitelist server: ${t.message}`,"error")}}document.addEventListener("DOMContentLoaded",(()=>{document.getElementById("admin-container")&&(async function(){const s=document.getElementById("guild-selector");if(s)try{const e=await fetch("/api/discord/guilds");if(!e.ok)throw new Error(`HTTP error ${e.status}`);const n=await e.json();s.innerHTML='<option value="" disabled selected>Please select a Discord server to configure</option>',n.forEach((e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,s.appendChild(t)})),s.addEventListener("change",handleGuildSelection),await t()}catch(t){console.error("Error fetching available guilds:",t),e("Failed to fetch available Discord servers. Please try again later.","error")}}(),renderDetectedGuilds(),function(){const e=document.getElementById("main-content");e&&(e.innerHTML='\n    <div class="container mx-auto px-4 py-8">\n      <h1 class="text-3xl font-bold mb-6">Admin Dashboard</h1>\n\n      <div class="bg-white shadow-md rounded-lg p-6 mb-8">\n        <h2 class="text-2xl font-semibold mb-4">Configure Discord Server Settings</h2>\n        <p class="text-gray-600 mb-6">Manage settings for each connected Discord server</p>\n\n        <div id="settings-message" class="hidden"></div>\n\n        <div class="mb-6">\n          <h3 class="text-xl font-semibold mb-3">Discord Servers</h3>\n          <div id="guild-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">\n            \x3c!-- Guild cards will be rendered here --\x3e\n          </div>\n          <p class="text-sm text-gray-500 mb-4">Note: New servers will inherit settings from the first configured server as a template</p>\n          <button id="add-new-guild-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded flex items-center">\n            <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">\n              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />\n            </svg>\n            Add New Server Configuration\n          </button>\n        </div>\n\n        \x3c!-- Detected servers section --\x3e\n        <div id="detected-guilds-section" class="mb-6 hidden">\n          <h3 class="text-xl font-semibold mb-3">Detected Servers</h3>\n          <p class="text-sm text-gray-600 mb-4">The following Discord servers have attempted to interact with the bot but are not yet whitelisted:</p>\n          <div id="detected-guilds-container" class="space-y-3">\n            \x3c!-- Detected guild cards will be rendered here --\x3e\n          </div>\n        </div>\n\n        <div id="no-server-selected" class="text-center p-8 border border-dashed border-gray-300 rounded-lg">\n          <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />\n          </svg>\n          <p class="text-gray-500 mb-2">Please select a Discord server to configure</p>\n          <p class="text-sm text-gray-400">Note: New servers will inherit settings from the first configured server as a template</p>\n        </div>\n\n        \x3c!-- Guild settings form is defined in guild-settings.html --\x3e\n      </div>\n    </div>\n  ')}(),setTimeout((()=>{t()}),1e3))}))})();