document.addEventListener("DOMContentLoaded",(()=>{const t={currentPage:1,pageSize:20,totalAvatars:0,currentStatusFilter:"all",currentModelFilter:"all",currentSearch:""};!async function(){try{const e=await fetch("/api/models/config"),r=await e.json(),n=document.getElementById("model-filter"),o=document.getElementById("avatar-model");Object.keys(r).forEach((t=>{const e=document.createElement("option");e.value=t,e.textContent=t,n.appendChild(e)})),Object.keys(r).forEach((t=>{const e=document.createElement("option");e.value=t,e.textContent=t,o.appendChild(e)})),n.addEventListener("change",(()=>{t.currentModelFilter=n.value,t.currentPage=1,a()}))}catch(t){console.error("Error loading models:",t)}}();const e={statusFilter:document.getElementById("status-filter"),modelFilter:document.getElementById("model-filter"),avatarsBody:document.getElementById("avatars-body"),paginationInfo:document.getElementById("pagination-info"),prevPageBtn:document.getElementById("prev-page"),nextPageBtn:document.getElementById("next-page"),avatarFilter:document.getElementById("avatar-filter"),avatarSearch:document.getElementById("avatar-search"),newAvatarBtn:document.getElementById("new-avatar"),avatarModal:document.getElementById("avatar-modal"),closeModal:document.getElementById("close-modal"),cancelEdit:document.getElementById("cancel-edit"),deleteAvatarBtn:document.getElementById("delete-avatar"),avatarForm:document.getElementById("avatar-form"),modalTitle:document.getElementById("modal-title"),imagePreview:document.getElementById("avatar-image-preview"),imageUrlInput:document.getElementById("avatar-image-url"),saveBtn:document.getElementById("save-avatar")};async function a(){try{if(t.currentSearch.trim().length>=2)return;const a=new URLSearchParams({page:t.currentPage,limit:t.pageSize,status:t.currentStatusFilter,model:t.currentModelFilter}),o=await fetch(`/api/avatars?${a}`);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const d=await o.json();if(d.error)throw new Error(d.error);const i=d.avatars||[];t.totalAvatars=d.total||0,0===i.length?e.avatarsBody.innerHTML='<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">No avatars found</td></tr>':n(i),r(t.totalAvatars,d.page||1,d.limit||t.pageSize)}catch(t){console.error("Error loading avatars:",t),e.avatarsBody.innerHTML='<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-red-500">Failed to load avatars</td></tr>'}}function r(t,e,a){const r=(e-1)*a+1,n=Math.min(e*a,t);document.getElementById("paginationInfo").textContent=`Showing ${r}-${n} of ${t} avatars`}function n(t){0!==t.length?(e.avatarsBody.innerHTML=t.map(o).join(""),document.querySelectorAll(".edit-avatar").forEach((t=>{t.addEventListener("click",(()=>async function(t){try{e.avatarModal.classList.remove("hidden"),e.modalTitle.textContent="Loading Avatar Data...";const a=await fetch(`/api/admin/avatars/${t}`);if(!a.ok)throw new Error(`HTTP error ${a.status}`);const r=await a.json();e.modalTitle.textContent=`Edit Avatar: ${r.name}`,e.avatarForm.dataset.avatarId=t,e.deleteAvatarBtn.classList.remove("hidden"),function(t){document.getElementById("avatar-name").value=t.name||"",document.getElementById("avatar-status").value=t.status||"alive",document.getElementById("avatar-model").value=t.model||"gemini-2.0-flash",document.getElementById("avatar-emoji").value=t.emoji||"",document.getElementById("avatar-description").value=t.description||"",document.getElementById("avatar-personality").value=t.personality||"",e.imageUrlInput.value=t.imageUrl||"",e.imagePreview.src=t.imageUrl||"",e.imagePreview.classList.toggle("hidden",!t.imageUrl)}(r)}catch(t){console.error("Error fetching avatar:",t),c(),l("Failed to load avatar details","error")}}(t.dataset.avatarId)))})),document.querySelectorAll(".delete-avatar").forEach((t=>{t.addEventListener("click",(()=>{confirm("Are you sure you want to delete this avatar?")&&deleteAvatar(t.dataset.avatarId)}))}))):e.avatarsBody.innerHTML='<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">No avatars found</td></tr>'}function o(t){return`\n      <tr>\n        <td class="px-6 py-4 whitespace-nowrap">\n          <img class="h-10 w-10 rounded-full object-cover" src="${t.thumbnailUrl||t.imageUrl||"/default-avatar.png"}" alt="${t.name||"Avatar"}">\n        </td>\n        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${t.name||"Unnamed"} ${t.emoji||""}</td>\n        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t._id}</td>\n        <td class="px-6 py-4 whitespace-nowrap">\n          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${e=t.status,{alive:"bg-green-100 text-green-800",dead:"bg-red-100 text-red-800",inactive:"bg-gray-100 text-gray-800"}[e]||"bg-gray-100 text-gray-800"}">\n            ${t.status||"Unknown"}\n          </span>\n        </td>\n        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.model||"Not specified"}</td>\n        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${function(t){if(!t)return"Unknown";const e=new Date(t);return isNaN(e.getTime())?"Invalid date":e.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}(t.createdAt)}</td>\n        <td class="px-6 py-4 whitespace-nowrap text-sm">\n          <button data-avatar-id="${t._id}" class="edit-avatar text-indigo-600 hover:text-indigo-900">Edit</button>\n          <button data-avatar-id="${t._id}" class="delete-avatar text-red-600 hover:text-red-900 ml-2">Delete</button>\n        </td>\n      </tr>\n    `;var e}function r(){const a=(t.currentPage-1)*t.pageSize+1,r=Math.min(t.currentPage*t.pageSize,t.totalAvatars);e.paginationInfo.textContent=`Showing ${a}-${r} of ${t.totalAvatars} avatars`,e.prevPageBtn.disabled=1===t.currentPage,e.nextPageBtn.disabled=r>=t.totalAvatars}function d(){e.avatarForm.dataset.avatarId="",e.modalTitle.textContent="Create New Avatar",e.deleteAvatarBtn.classList.add("hidden"),e.avatarForm.reset(),e.imagePreview.src="",e.imagePreview.classList.add("hidden"),e.imageUrlInput.value="",e.avatarModal.classList.remove("hidden")}async function i(t){t.preventDefault();const r=e.avatarForm.dataset.avatarId,n=r?"PUT":"POST",o=r?`/api/admin/avatars/${r}`:"/api/admin/avatars",d=new FormData(e.avatarForm);e.saveBtn.disabled=!0,e.saveBtn.textContent="Saving...";try{const t=await fetch(o,{method:n,headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(d))});if(!t.ok)throw new Error(`HTTP error ${t.status}`);c(),a(),l(r?"Avatar updated successfully":"Avatar created successfully")}catch(t){console.error("Error saving avatar:",t),l("Failed to save avatar","error")}finally{e.saveBtn.disabled=!1,e.saveBtn.textContent="Save Changes"}}async function s(){const t=e.avatarForm.dataset.avatarId;if(t&&confirm("Are you sure you want to delete this avatar?"))try{const e=await fetch(`/api/admin/avatars/${t}`,{method:"DELETE"});if(!e.ok)throw new Error(`HTTP error ${e.status}`);c(),a(),l("Avatar deleted successfully")}catch(t){console.error("Error deleting avatar:",t),l("Failed to delete avatar","error")}}function c(){e.avatarModal.classList.add("hidden")}function l(t,e="success"){const a=document.createElement("div");a.className="fixed bottom-4 right-4 z-50";const r=document.createElement("div");r.className=`p-3 rounded shadow-lg ${"success"===e?"bg-green-500":"bg-red-500"} text-white`,r.textContent=t,a.appendChild(r),document.body.appendChild(a),setTimeout((()=>a.remove()),3e3)}function m(t,e){let a;return function(...r){clearTimeout(a),a=setTimeout((()=>t.apply(this,r)),e)}}a(),function(){e.prevPageBtn.addEventListener("click",(()=>{t.currentPage>1&&(t.currentPage--,a())})),e.nextPageBtn.addEventListener("click",(()=>{t.currentPage*t.pageSize<t.totalAvatars&&(t.currentPage++,a())})),e.statusFilter.addEventListener("change",(()=>{t.currentStatusFilter=e.statusFilter.value,t.currentPage=1,a()})),e.avatarSearch.addEventListener("input",m((()=>{t.currentSearch=e.avatarSearch.value,t.currentPage=1,a()}),300)),e.newAvatarBtn.addEventListener("click",d),e.closeModal.addEventListener("click",c),e.cancelEdit.addEventListener("click",c),document.getElementById("preview-prompt").addEventListener("click",(async()=>{const t=e.avatarForm.dataset.avatarId;if(!t)return void l("Please save the avatar first to preview prompts","error");const a=document.getElementById("prompt-preview-container"),r=document.getElementById("prompt-preview-content");try{r.innerHTML="Loading preview...",a.classList.remove("hidden");const e=await fetch(`/api/admin/avatars/${t}/preview-prompt`);if(!e.ok)throw new Error(`HTTP error ${e.status}`);const n=await e.json();r.innerHTML=n.prompt||"No prompt preview available"}catch(t){console.error("Error fetching prompt preview:",t),r.innerHTML=`Error loading preview: ${t.message}`}})),document.addEventListener("keydown",(t=>{"Escape"!==t.key||e.avatarModal.classList.contains("hidden")||c()})),e.avatarForm.addEventListener("submit",i),e.deleteAvatarBtn.addEventListener("click",s);const r=document.createElement("input");r.type="file",r.accept="image/*",r.style.display="none",document.body.appendChild(r);const n=document.createElement("button");n.textContent="Upload Image",n.className="ml-2 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",e.imageUrlInput.parentNode.appendChild(n),n.addEventListener("click",(()=>{r.click()})),r.addEventListener("change",(async t=>{const a=t.target.files[0];if(!a)return;const o=new FormData;o.append("image",a);try{n.disabled=!0,n.textContent="Uploading...";const t=await fetch("/api/admin/upload-image",{method:"POST",body:o});if(!t.ok)throw new Error(`Upload failed: ${t.statusText}`);const a=await t.json();e.imageUrlInput.value=a.url,e.imagePreview.src=a.url,e.imagePreview.classList.remove("hidden"),l("Image uploaded successfully")}catch(t){console.error("Upload error:",t),l("Failed to upload image","error")}finally{n.disabled=!1,n.textContent="Upload Image",r.value=""}})),e.imageUrlInput.addEventListener("input",(()=>{const t=e.imageUrlInput.value;e.imagePreview.src=t,e.imagePreview.classList.toggle("hidden",!t)}))}(),e.avatarSearch.addEventListener("input",m((()=>{const r=e.avatarSearch.value.trim();t.currentSearch=r,r.length>=2?async function(t){try{const a=await fetch(`/api/avatars/search?name=${encodeURIComponent(t)}`);if(!a.ok)throw new Error(`HTTP error ${a.status}`);const r=(await a.json()).avatars||[];0===r.length?e.avatarsBody.innerHTML='<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">No avatars found</td></tr>':n(r)}catch(t){console.error("Error searching avatars:",t),e.avatarsBody.innerHTML='<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-red-500">Failed to search avatars</td></tr>'}}(r):(t.currentPage=1,t.currentSearch="",a())}),300))}));