
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location Service - CosyWorld Documentation</title>
  <!-- Mermaid script for diagram rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      mermaid.initialize({ 
        startOnLoad: true,
        theme: 'dark',
        securityLevel: 'loose'
      });
    });
  </script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
    }
    nav {
      width: 250px;
      padding-right: 2rem;
      flex-shrink: 0;
    }
    main {
      flex-grow: 1;
    }
    code {
      background: #f5f5f5;
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
      font-size: 85%;
    }
    pre {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 5px;
      overflow: auto;
    }
    pre code {
      background: none;
      padding: 0;
    }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    h1, h2, h3, h4 { margin-top: 1.5em; margin-bottom: 0.5em; }
    h1 { border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    nav ul { list-style-type: none; padding-left: 1.2em; }
    nav > ul { padding-left: 0; }
    .section-title { 
      font-weight: bold; 
      margin-top: 1em;
      color: #24292e;
    }
    /* Mermaid diagram styling */
    .mermaid {
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <nav><ul><li><a href="../../index.html">Home</a></li><li><span class="section-title">Overview</span><ul><li><a href="../../overview/03-system-diagram.html">System Diagram</a></li><li><a href="../../overview/02-system-overview.html">System Overview</a></li><li><a href="../../overview/01-introduction.html">CosyWorld Introduction</a></li></ul></li><li><span class="section-title">Systems</span><ul><li><a href="../../systems/06-rati-avatar-system.html">RATi Avatar System</a></li><li><a href="../../systems/05-intelligence-system.html">Intelligence System</a></li><li><a href="../../systems/04-action-system.html">Action System</a></li></ul></li><li><span class="section-title">Services</span><ul><li><a href="../../services/x-authentication.html">X (Twitter) Authentication and Integration</a></li><li><a href="../../services/architecture-report.html">CosyWorld Architecture Report</a></li><li><a href="../../services/README.html">CosyWorld Services Documentation</a></li><li><span class="section-title">World</span><ul><li><a href="../../services/world/questGeneratorService.html">Quest Generator Service</a></li><li><a href="../../services/world/locationService.html">Location Service</a></li><li><a href="../../services/world/itemService.html">Item Service</a></li></ul></li><li><span class="section-title">Web</span><ul><li><a href="../../services/web/webService.html">Web Service</a></li></ul></li><li><span class="section-title">Tools</span><ul><li><a href="../../services/tools/toolService.html">Tool Service</a></li></ul></li><li><span class="section-title">Social</span><ul><li><a href="../../services/social/x-integration.html">X (Twitter) Integration</a></li><li><a href="../../services/social/telegram-integration.html">Telegram Integration (Coming Soon)</a></li><li><a href="../../services/social/discord-integration.html">Discord Integration</a></li><li><a href="../../services/social/README.html">Social Integrations</a></li></ul></li><li><span class="section-title">S3</span><ul><li><a href="../../services/s3/s3Service.html">S3 Service</a></li></ul></li><li><span class="section-title">Quest</span><ul><li><a href="../../services/quest/questGeneratorService.html">Quest Generator Service</a></li></ul></li><li><span class="section-title">Media</span><ul><li><a href="../../services/media/s3Service.html">S3 Service</a></li><li><a href="../../services/media/imageProcessingService.html">Image Processing Service</a></li></ul></li><li><span class="section-title">Location</span><ul><li><a href="../../services/location/locationService.html">Location Service</a></li></ul></li><li><span class="section-title">Item</span><ul><li><a href="../../services/item/itemService.html">Item Service</a></li></ul></li><li><span class="section-title">Integration</span><ul><li><a href="../../services/integration/x-authentication.html">X (Twitter) Authentication and Integration</a></li></ul></li><li><span class="section-title">Foundation</span><ul><li><a href="../../services/foundation/logger.html">Logger Service</a></li><li><a href="../../services/foundation/databaseService.html">Database Service</a></li><li><a href="../../services/foundation/configService.html">Config Service</a></li><li><a href="../../services/foundation/basicService.html">Basic Service</a></li></ul></li><li><span class="section-title">Entity</span><ul><li><a href="../../services/entity/memoryService.html">Memory Service</a></li><li><a href="../../services/entity/avatarService.html">Avatar Service</a></li></ul></li><li><span class="section-title">Core</span><ul><li><a href="../../services/core/promptService.html">Prompt Service</a></li><li><a href="../../services/core/memoryService.html">Memory Service</a></li><li><a href="../../services/core/databaseService.html">Database Service</a></li><li><a href="../../services/core/basicService.html">Basic Service</a></li><li><a href="../../services/core/avatarService.html">Avatar Service</a></li><li><a href="../../services/core/aiService.html">AI Service</a></li></ul></li><li><span class="section-title">Communication</span><ul><li><a href="../../services/communication/conversationManager.html">Conversation Manager</a></li></ul></li><li><span class="section-title">Chat</span><ul><li><a href="../../services/chat/conversationManager.html">Conversation Manager</a></li></ul></li><li><span class="section-title">Blockchain</span><ul><li><a href="../../services/blockchain/tokenService.html">Token Service</a></li></ul></li><li><span class="section-title">Ai</span><ul><li><a href="../../services/ai/replicateService.html">Replicate Service</a></li><li><a href="../../services/ai/promptService.html">Prompt Service</a></li><li><a href="../../services/ai/openrouterAIService.html">OpenRouter AI Service</a></li><li><a href="../../services/ai/ollamaService.html">Ollama Service</a></li><li><a href="../../services/ai/googleAIService.html">Google AI Service</a></li><li><a href="../../services/ai/aiService.html">AI Service</a></li></ul></li></ul></li><li><span class="section-title">Deployment</span><ul><li><a href="../../deployment/08-future-work.html">Future Work Priorities</a></li><li><a href="../../deployment/07-deployment.html">Deployment Guide</a></li></ul></li></ul></nav>
  <main><h1>Location Service</h1>
<h2>Overview</h2>
<p>The LocationService manages the spatial aspects of the RATi Avatar System, including physical locations, their descriptions, and avatar positioning. It implements the RATi NFT Metadata Standard for locations, enabling them to exist as on-chain assets with autonomous properties and contextual effects on avatars. Locations provide the geographical foundation for all interactions within the ecosystem.</p>
<h2>Functionality</h2>
<ul>
<li><strong>Location Management</strong>: Creates, updates, and tracks locations as NFT assets</li>
<li><strong>Avatar Positioning</strong>: Tracks which avatars are in which locations with on-chain verification</li>
<li><strong>Location Description</strong>: Maintains rich, AI-driven descriptions that evolve based on events</li>
<li><strong>Location Discovery</strong>: Enables finding locations by various criteria with blockchain indexing</li>
<li><strong>Doorway Creation</strong>: Manages temporary connections between locations for cross-wallet interaction</li>
<li><strong>Blockchain Integration</strong>: Supports on-chain verification and persistent storage</li>
</ul>
<h2>Implementation</h2>
<p>The LocationService extends BasicService and uses both database and blockchain storage to persist location information. It maps Discord channels and threads to in-game locations with on-chain NFT representations.</p>
<pre><code class="language-javascript">export class LocationService extends BasicService {
  constructor(services) {
    super(services, [
      'databaseService',
      'discordService',
      'aiService',
      'configService',
      'arweaveService',
      'nftMintService',
    ]);
    
    this.db = this.databaseService.getDatabase();
    this.client = this.discordService.client;
    
    // Additional initialization...
  }
  
  // Methods...
}
</code></pre>
<h3>Key Methods</h3>
<h4><code>createLocation(data)</code></h4>
<p>Creates a new location with RATi-compliant metadata, generating missing fields with AI services.</p>
<h4><code>getLocationById(locationId)</code></h4>
<p>Retrieves location information by its database ID, with optional blockchain verification.</p>
<h4><code>getLocationByChannelId(channelId)</code></h4>
<p>Finds a location based on its associated Discord channel ID.</p>
<h4><code>updateLocation(locationId, updateData)</code></h4>
<p>Updates an existing location with new information, maintaining on-chain consistency.</p>
<h4><code>getLocationDescription(channelId, channelName)</code></h4>
<p>Generates a formatted description of a location for use in prompts, based on its metadata.</p>
<h4><code>getLocationAndAvatars(channelId)</code></h4>
<p>Retrieves both the location details and a list of avatars currently in that location.</p>
<h4><code>moveAvatarToLocation(avatarId, locationId, options)</code></h4>
<p>Moves an avatar to a new location, updating relevant tracking information across platforms.</p>
<h4><code>createDoorway(sourceLocationId, targetLocationId, options)</code></h4>
<p>Creates a temporary connection between locations, following the Doorway specification in the RATi standard.</p>
<h4><code>updateArweaveMetadata(location)</code></h4>
<p>Updates permanent storage with current location data for blockchain integration.</p>
<h4><code>mintNFTFromLocation(location, walletAddress)</code></h4>
<p>Creates an on-chain NFT representation of a location following the RATi NFT Metadata Standard.</p>
<h2>RATi NFT Metadata Integration</h2>
<p>Locations implement the RATi NFT Metadata Standard with these mappings:</p>
<pre><code class="language-javascript">// Standard RATi metadata for locations
const ratiMetadata = {
  tokenId: location._id.toString(),
  name: location.name,
  description: location.description,
  media: {
    image: location.imageUrl
  },
  attributes: [
    { trait_type: &quot;Region&quot;, value: location.region || &quot;Unknown&quot; },
    { trait_type: &quot;Ambience&quot;, value: location.ambience || &quot;Neutral&quot; },
    { trait_type: &quot;Accessibility&quot;, value: location.public ? &quot;Public&quot; : &quot;Private&quot; }
  ],
  storage: {
    primary: location.arweaveId ? `ar://${location.arweaveId}` : null,
    backup: location.ipfsId ? `ipfs://${location.ipfsId}` : null
  },
  evolution: {
    level: location.evolutionLevel || 1,
    previous: location.sourceLocationIds || [],
    timestamp: location.updatedAt.toISOString()
  },
  memory: {
    recent: location.eventArweaveId ? `ar://${location.eventArweaveId}` : null,
    archive: null
  }
};
</code></pre>
<h2>Location Schema</h2>
<p>Locations follow a standardized schema that extends the RATi NFT Metadata Standard:</p>
<h3>Core Identity</h3>
<ul>
<li><code>name</code>: Human-readable location name</li>
<li><code>description</code>: Detailed atmospheric description</li>
<li><code>imageUrl</code>: Visual representation URL</li>
<li><code>region</code>: Geographical or thematic classification</li>
<li><code>ambience</code>: Mood and atmospheric properties</li>
<li><code>arweaveId</code>: Permanent storage identifier</li>
<li><code>tokenId</code>: On-chain NFT identifier (when minted)</li>
</ul>
<h3>Platform Integration</h3>
<ul>
<li><code>channelId</code>: Associated Discord channel/thread ID</li>
<li><code>type</code>: “channel” or “thread”</li>
<li><code>parentId</code>: Parent location (for threads or nested locations)</li>
<li><code>public</code>: Whether the location is publicly accessible</li>
</ul>
<h3>Environmental Properties</h3>
<ul>
<li><code>weather</code>: Current weather conditions</li>
<li><code>timeOfDay</code>: Current time period</li>
<li><code>hazards</code>: Potential dangers or effects</li>
<li><code>resources</code>: Available resources</li>
<li><code>specialFeatures</code>: Unique location properties</li>
</ul>
<h3>Evolution and History</h3>
<ul>
<li><code>evolutionLevel</code>: Current upgrade level</li>
<li><code>sourceLocationIds</code>: Array of locations used to create this location</li>
<li><code>eventArweaveId</code>: Record of significant events</li>
<li><code>visitCount</code>: Number of unique avatar visits</li>
</ul>
<h2>Location Types</h2>
<h3>Social Hubs</h3>
<ul>
<li>Central gathering places for multiple avatars</li>
<li>Enhanced communication features</li>
<li>Public accessibility by default</li>
<li>Often contain information boards and services</li>
</ul>
<h3>Adventure Zones</h3>
<ul>
<li>Exploration-focused environments</li>
<li>May contain special items and discoveries</li>
<li>Often have environmental challenges</li>
<li>Support for quest-based activities</li>
</ul>
<h3>Private Realms</h3>
<ul>
<li>Owner-restricted access</li>
<li>Customizable environments</li>
<li>Personal storage capabilities</li>
<li>Doorway creation privileges</li>
</ul>
<h3>Doorways</h3>
<ul>
<li>Temporary connections between locations</li>
<li>Time-limited access permissions</li>
<li>Enable cross-wallet social interactions</li>
<li>Created by specific avatar types or items</li>
</ul>
<h2>Autonomous Behaviors</h2>
<p>Locations can exhibit autonomous behaviors based on:</p>
<ul>
<li><strong>Region Type</strong>: Different regions have distinct environmental patterns</li>
<li><strong>Avatar Presence</strong>: Responds to the number and type of avatars present</li>
<li><strong>Time Cycles</strong>: Changes based on system-wide time progressions</li>
<li><strong>Special Events</strong>: Transforms during scheduled or triggered events</li>
<li><strong>Ownership Actions</strong>: Responds to owner-initiated customizations</li>
</ul>
<h2>Dependencies</h2>
<ul>
<li>DatabaseService: For traditional persistence of location data</li>
<li>DiscordService: For channel interaction and management</li>
<li>AIService: For generating location descriptions</li>
<li>ArweaveService: For permanent metadata storage</li>
<li>NFTMintService: For on-chain location minting</li>
<li>ConfigService: For location-related settings</li>
</ul>
<h2>Blockchain Integration</h2>
<p>The LocationService provides several blockchain-related features:</p>
<ul>
<li><strong>NFT Minting</strong>: Creation of on-chain location representations</li>
<li><strong>Metadata Storage</strong>: Permanent recording of location properties on Arweave</li>
<li><strong>Access Control</strong>: Verification of avatar permissions for restricted locations</li>
<li><strong>Doorway Management</strong>: Implementation of cross-wallet location connections</li>
<li><strong>Cross-Platform Consistency</strong>: Maintaining consistent representation across platforms</li>
</ul>
</main>
</body>
</html>
