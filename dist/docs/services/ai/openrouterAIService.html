
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenRouter AI Service - CosyWorld Documentation</title>
  <!-- Mermaid script for diagram rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      mermaid.initialize({ 
        startOnLoad: true,
        theme: 'dark',
        securityLevel: 'loose'
      });
    });
  </script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
    }
    nav {
      width: 250px;
      padding-right: 2rem;
      flex-shrink: 0;
    }
    main {
      flex-grow: 1;
    }
    code {
      background: #f5f5f5;
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace;
      font-size: 85%;
    }
    pre {
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 5px;
      overflow: auto;
    }
    pre code {
      background: none;
      padding: 0;
    }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    h1, h2, h3, h4 { margin-top: 1.5em; margin-bottom: 0.5em; }
    h1 { border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
    nav ul { list-style-type: none; padding-left: 1.2em; }
    nav > ul { padding-left: 0; }
    .section-title { 
      font-weight: bold; 
      margin-top: 1em;
      color: #24292e;
    }
    /* Mermaid diagram styling */
    .mermaid {
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <nav><ul><li><a href="../../index.html">Home</a></li><li><span class="section-title">Overview</span><ul><li><a href="../../overview/03-system-diagram.html">System Diagram</a></li><li><a href="../../overview/02-system-overview.html">System Overview</a></li><li><a href="../../overview/01-introduction.html">CosyWorld Introduction</a></li></ul></li><li><span class="section-title">Systems</span><ul><li><a href="../../systems/06-dungeon-system.html">Dungeon System</a></li><li><a href="../../systems/05-intelligence-system.html">Intelligence System</a></li><li><a href="../../systems/04-action-system.html">Action System</a></li></ul></li><li><span class="section-title">Services</span><ul><li><a href="../../services/x-authentication.html">X (Twitter) Authentication and Integration</a></li><li><a href="../../services/architecture-report.html">CosyWorld Architecture Report</a></li><li><a href="../../services/README.html">CosyWorld Services Documentation</a></li><li><span class="section-title">World</span><ul><li><a href="../../services/world/questGeneratorService.html">Quest Generator Service</a></li><li><a href="../../services/world/locationService.html">Location Service</a></li><li><a href="../../services/world/itemService.html">Item Service</a></li></ul></li><li><span class="section-title">Web</span><ul><li><a href="../../services/web/webService.html">Web Service</a></li></ul></li><li><span class="section-title">Tools</span><ul><li><a href="../../services/tools/toolService.html">Tool Service</a></li></ul></li><li><span class="section-title">S3</span><ul><li><a href="../../services/s3/s3Service.html">S3 Service</a></li></ul></li><li><span class="section-title">Quest</span><ul><li><a href="../../services/quest/questGeneratorService.html">Quest Generator Service</a></li></ul></li><li><span class="section-title">Media</span><ul><li><a href="../../services/media/s3Service.html">S3 Service</a></li><li><a href="../../services/media/imageProcessingService.html">Image Processing Service</a></li></ul></li><li><span class="section-title">Location</span><ul><li><a href="../../services/location/locationService.html">Location Service</a></li></ul></li><li><span class="section-title">Item</span><ul><li><a href="../../services/item/itemService.html">Item Service</a></li></ul></li><li><span class="section-title">Integration</span><ul><li><a href="../../services/integration/x-authentication.html">X (Twitter) Authentication and Integration</a></li></ul></li><li><span class="section-title">Foundation</span><ul><li><a href="../../services/foundation/logger.html">Logger Service</a></li><li><a href="../../services/foundation/databaseService.html">Database Service</a></li><li><a href="../../services/foundation/configService.html">Config Service</a></li><li><a href="../../services/foundation/basicService.html">Basic Service</a></li></ul></li><li><span class="section-title">Entity</span><ul><li><a href="../../services/entity/memoryService.html">Memory Service</a></li><li><a href="../../services/entity/avatarService.html">Avatar Service</a></li></ul></li><li><span class="section-title">Core</span><ul><li><a href="../../services/core/promptService.html">Prompt Service</a></li><li><a href="../../services/core/memoryService.html">Memory Service</a></li><li><a href="../../services/core/databaseService.html">Database Service</a></li><li><a href="../../services/core/basicService.html">Basic Service</a></li><li><a href="../../services/core/avatarService.html">Avatar Service</a></li><li><a href="../../services/core/aiService.html">AI Service</a></li></ul></li><li><span class="section-title">Communication</span><ul><li><a href="../../services/communication/conversationManager.html">Conversation Manager</a></li></ul></li><li><span class="section-title">Chat</span><ul><li><a href="../../services/chat/conversationManager.html">Conversation Manager</a></li></ul></li><li><span class="section-title">Blockchain</span><ul><li><a href="../../services/blockchain/tokenService.html">Token Service</a></li></ul></li><li><span class="section-title">Ai</span><ul><li><a href="../../services/ai/replicateService.html">Replicate Service</a></li><li><a href="../../services/ai/promptService.html">Prompt Service</a></li><li><a href="../../services/ai/openrouterAIService.html">OpenRouter AI Service</a></li><li><a href="../../services/ai/ollamaService.html">Ollama Service</a></li><li><a href="../../services/ai/googleAIService.html">Google AI Service</a></li><li><a href="../../services/ai/aiService.html">AI Service</a></li></ul></li></ul></li><li><span class="section-title">Deployment</span><ul><li><a href="../../deployment/08-future-work.html">Future Work Priorities</a></li><li><a href="../../deployment/07-deployment.html">Deployment Guide</a></li></ul></li></ul></nav>
  <main><h1>OpenRouter AI Service</h1>
<h2>Overview</h2>
<p>The OpenRouter AI Service provides access to a wide variety of AI models from different providers through the OpenRouter API. This service serves as the default AI provider for the system, offering robust capabilities, model fallback mechanisms, and flexible configuration options.</p>
<h2>Functionality</h2>
<ul>
<li><strong>Multiple Model Access</strong>: Single interface to access models from OpenAI, Anthropic, Meta, and other providers</li>
<li><strong>Random Model Selection</strong>: Tiered model selection based on rarity categories</li>
<li><strong>Chat Completions</strong>: Process multi-turn conversations with context</li>
<li><strong>Text Completions</strong>: Generate text from prompts</li>
<li><strong>Model Fallback</strong>: Automatic fallback to alternative models when requested models are unavailable</li>
<li><strong>Fuzzy Model Matching</strong>: Find similar model names when exact matches aren’t found</li>
</ul>
<h2>Implementation</h2>
<p>The service extends <code>BasicService</code> and uses the OpenAI SDK configured to connect to OpenRouter’s API endpoint. It implements model selection logic, rarity-based randomization, and comprehensive error handling.</p>
<pre><code class="language-javascript">// Initialization in the service
this.openai = new OpenAI({
  apiKey: this.configService.config.ai.openrouter.apiKey,
  baseURL: 'https://openrouter.ai/api/v1',
  defaultHeaders: {
    'HTTP-Referer': 'https://ratimics.com',
    'X-Title': 'rativerse',
  },
});
</code></pre>
<h3>Model Selection System</h3>
<p>The service implements a D20-based random model selection system that categorizes models by rarity:</p>
<ul>
<li>Common (60%): Rolls 1-12</li>
<li>Uncommon (25%): Rolls 13-17</li>
<li>Rare (10%): Rolls 18-19</li>
<li>Legendary (5%): Roll 20</li>
</ul>
<p>This system adds variety to AI responses and allows for occasional use of more powerful (and potentially more expensive) models.</p>
<h2>Rarity-Based Model Selection</h2>
<pre><code class="language-javascript">async selectRandomModel() {
  // Roll a d20 to determine rarity tier
  const roll = Math.ceil(Math.random() * 20);
  
  // Select rarity based on roll ranges
  const selectedRarity = rarityRanges.find(
    range =&gt; roll &gt;= range.min &amp;&amp; roll &lt;= range.max
  )?.rarity;
  
  // Filter and return random model from that tier
  const availableModels = this.modelConfig.filter(
    model =&gt; model.rarity === selectedRarity
  );
  
  if (availableModels.length &gt; 0) {
    return availableModels[Math.floor(Math.random() * availableModels.length)].model;
  }
  return this.model; // Fallback to default
}
</code></pre>
<h2>Configuration Options</h2>
<p>The service provides default configurations for different types of completions:</p>
<h3>Chat Defaults</h3>
<pre><code class="language-javascript">this.defaultChatOptions = {
  model: 'meta-llama/llama-3.2-1b-instruct',
  temperature: 0.7,
  max_tokens: 1000,
  top_p: 1.0,
  frequency_penalty: 0,
  presence_penalty: 0,
};
</code></pre>
<h3>Completion Defaults</h3>
<pre><code class="language-javascript">this.defaultCompletionOptions = {
  temperature: 0.7,
  max_tokens: 1000,
  top_p: 1.0,
  frequency_penalty: 0,
  presence_penalty: 0,
};
</code></pre>
<h3>Vision Defaults</h3>
<pre><code class="language-javascript">this.defaultVisionOptions = {
  model: 'x-ai/grok-2-vision-1212',
  temperature: 0.5,
  max_tokens: 200,
};
</code></pre>
<h2>Error Handling and Retries</h2>
<p>The service implements a robust retry mechanism for rate limit errors:</p>
<ul>
<li>Automatic retry after a 5-second delay</li>
<li>Configurable number of retry attempts</li>
<li>Detailed error logging</li>
<li>Graceful fallback to default models</li>
</ul>
<h2>Dependencies</h2>
<ul>
<li>OpenAI SDK (configured for OpenRouter)</li>
<li>String similarity library for fuzzy model matching</li>
<li>Model configuration file (<code>models.config.mjs</code>)</li>
<li>Configuration service for API keys and defaults</li>
</ul>
<h2>Usage Examples</h2>
<h3>Chat Completion</h3>
<pre><code class="language-javascript">const response = await openRouterService.chat([
  { role: 'system', content: 'You are a fantasy game assistant.' },
  { role: 'user', content: 'Create a magical item for my character.' }
], {
  model: 'anthropic/claude-3-opus-20240229'
});
</code></pre>
<h3>Structured Output</h3>
<pre><code class="language-javascript">const characterData = await openRouterService.chat([
  { role: 'user', content: 'Generate a fantasy character' }
], {
  schema: {
    type: 'object',
    properties: {
      name: { type: 'string' },
      class: { type: 'string' },
      level: { type: 'number' },
      abilities: { type: 'array', items: { type: 'string' } }
    },
    required: ['name', 'class', 'level', 'abilities']
  }
});
</code></pre>
<h3>Item Speech Generation</h3>
<pre><code class="language-javascript">const itemSpeech = await openRouterService.speakAsItem({
  name: 'Ancient Amulet of Whispering',
  description: 'A mysterious amulet that seems to murmur secrets from bygone eras.'
}, 'dungeon-channel-123');
</code></pre>
<h2>Limitations</h2>
<ul>
<li>Image analysis capabilities may be limited compared to specialized vision models</li>
<li>Availability and performance of specific models depends on OpenRouter’s agreements with providers</li>
<li>Rate limits and costs vary by model provider</li>
</ul>
</main>
</body>
</html>
